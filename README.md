# Discord Docker Container Manager

A Discord bot that manages Docker containers, allowing authorized users to create and destroy containers bound to Discord accounts.

## Features

- **One container per user**: Each Discord user can only have one container
- **Allowlist system**: Only specific users can create/destroy containers
- **Database tracking**: SQLite database stores container records linked to Discord user IDs (snowflakes)
- **Docker integration**: Full Docker API support for container management

## Setup

1. Install dependencies:
```bash
pip install -r requirements.txt
```

2. Copy `env.example` to `.env` and configure:
```bash
cp env.example .env
```

3. Edit `.env` and add:
   - Your Discord bot token
   - Authorized user IDs (comma-separated Discord user IDs)

4. Run the bot:
```bash
python bot.py
```

## Configuration

The `.env` file should contain:
- `DISCORD_TOKEN`: Your Discord bot token
- `AUTHORIZED_USERS`: Comma-separated list of Discord user IDs (snowflakes) allowed to use commands
- `TERMINAL_SERVICE_URL`: Base URL for the Flask terminal service (defaults to `http://localhost:5000`)

## Commands

- `/create <user> <container_name> [image]` - Create a container for a user (defaults to `ubuntu:24.04` if image omitted)
- `/destroy <user_id>` - Destroy a user's container
- `/list` - List all containers
- `/status <user_id>` - Check container status for a user
- `/terminal` - Generate a one-time link to the web terminal for your container

## Web Terminal Service

The `/terminal` command relies on a Flask service that launches [ttyd](https://github.com/tsl0922/ttyd) to provide a browser-based shell into each user's container.

### Prerequisites

- Install `ttyd` on the host running the Flask service. On macOS with Homebrew:
  ```bash
  brew install ttyd
  ```
  (Alternatively, download a release binary from the ttyd GitHub page.)
- Ensure the service has access to the Docker daemon (e.g., same host or via mounted Docker socket).

### Running the Terminal Service

1. Set `TERMINAL_SERVICE_URL` in your `.env` (e.g., `http://localhost:5000`).
2. Start the Flask server:
   ```bash
   python terminal_service.py
   ```
   The service listens on port `5000` by default and exposes:
   - `GET /health` — basic health check
   - `GET /terminal/<container_id>?token=<token>` — validates the token, launches `ttyd`, and redirects the browser to the live terminal session.

Each session:
- Uses a one-time token generated by the Discord bot (`/terminal` command).
- Launches `ttyd --once docker exec -it <container_id> /bin/bash` on a random port.
- Automatically tears down when the terminal window closes or the token expires (default 1 hour).

> **Security note:** `ttyd` runs on a randomly chosen port per request. For production deployments, consider running the Flask service behind a reverse proxy with TLS and restricting network access to the temporary ports that ttyd binds.

## Database

The bot uses SQLite (`containers.db`) to track:
- Discord user ID (snowflake)
- Container name
- Container ID
- Image used
- Created timestamp

